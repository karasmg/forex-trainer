<!doctype html>
<html ng-app="workApp">
<head>
    <style>
        [ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak {
            display: none;
        }
    </style>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
</head>
<body ng-controller="workController" style="position: relative;">
    <iframe name="frame" width=100% height=100% style="position:absolute;z-index:-1"></iframe>
<div class="panel">
    <table ng-cloak class="table table-striped" ng-repeat="item in list">
        <CAPTION style="text-align: left; color: black; font-size: larger"><b>{{item.name}}</b><input ng-click="body_height()" ng-model="checked" style="margin: 0 10px 0 50px"  type="checkbox"><span>{{on_lable(checked)}}</span></CAPTION>
        <thead ng-hide="checked">
        <tr>
            <th>Вид работ</th>
            <th>Цена</th>
            <th>Количество</th>
            <th>Единицы</th>
            <th>Сумма</th>
            <th>Считать</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-hide="checked" ng-repeat="item in item.price">
            <td style="min-width: 50%">{{item.work}}</td>
            <td>{{item.price}}</td>
            <td><input type="text" ng-model="item.amount" /></td>
            <td>{{item.units}}</td>
            <td><span class="ng-binding" style="display: inline-block; text-align: right; width: 90px;" align="right">{{getSum(item.price, item.amount) | currency:""}}</span></td>
            <td><input type="checkbox" ng-model="item.done" /></td>
        </tr>
        <tr>
            <td><b>Итого: </b></td>
            <td></td>
            <td></td>
            <td></td>
            <td><b><span class="ng-binding" style="display: inline-block; text-align: right; width: 90px;" align="right">{{ getTotal(item.price) | currency:""}}</span></b></td>
            <td></td>
        </tr>
        </tbody>
    </table>
</div>
    <div style="float: right;"><b>Общая сумма по всем разделам: {{totalSum() | currency:""}}</b></div>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js"></script>
<script>
    function isNum(n){
        if(n.search(/^\d+(\.|,)?\d*$/)<0) {
            return false;
        } else {
            return true;
        }
    }

    function setHeight() {
        console.log('setHeight');
        var api_params = {
            'type': 'heightdata',
            'height': document.body.scrollHeight,
        };
        parent.postMessage(JSON.stringify(api_params), '*');
    }

        setTimeout(function () { // Отработка задержки фрейма (для FF и ИЕ)
            var timerResize = 'first';
            frame.onresize = function () { // frame,  - Имя фрейма (name=frame)  - cм начало Кода;
                if (timerResize !== 'first')clearTimeout(timerResize);
                timerResize = setTimeout(function () {  //  Задержка для очистки  чрезмерных срабатываний;
                    setHeight();
                }, 20)  // Параметр 20(ms) , - зависит от нужной скорости реагирования на повторные события;
                        // актуально при плавных изменениях размера элемента,
                        // либо почти одновременное изменением размера несколькими разными процессами.
            }
        }, 200);

    var countChapter=0;
    var workApp = angular.module("workApp", []);



    workApp.controller("workController",  ['$scope', '$window', '$timeout', function($scope, $window, $timeout) {
        var dataName = 'items'+countChapter;
        countChapter++;
        $scope.list = model;

        $scope.getTotal = function(price){
            var total = 0;
            for(var i = 0; i < price.length; i++){
                var item = price[i];
                if(item.done){
                    total += $scope.getSum(item.price, item.amount);
                }
            }
            return total;
        };

        $scope.getSum = function (price, amount){
            var temp_amount  = amount.replace(",", ".");
            if(isNum(temp_amount)) {
                return price * temp_amount;
            } else return 0;
        }

        $scope.totalSum = function(){
            setHeight();
            var total = 0;
            for(var i = 0; i < $scope.list.length; i++){
                total += this.getTotal($scope.list[i].price);
            }
            return total;
        };

        $scope.on_lable = function(checked){

            if(checked){
                return "развернуть";
            } else return "свернуть";

        };


    }]);


    var model = [
        {name: 'Электрика', price: [
            { work: "Укладка электрического кабеля", done: true, price: 15, units: 'шт', amount:""},
            { work: "Укладка гофры", done: true, price: 12, units: 'м', amount:""},
            { work: "Укладка металлорукава", done: true, price: 583, units: 'м', amount:""},
            { work: "Укладка кабель-канала", done: true, price: 55, units: 'кв. м', amount:""},
            { work: "Монтаж электрического щита", done: true, price: 418, units: 'шт', amount:""},
            { work: "Оборудование заземления, громоотвода", done: true, price: 156, units: 'м', amount:""},
            { work: "Подключение к силовой электросети", done: true, price: 15, units: 'м', amount:""},
            { work: "Набор электрощита (монтаж автоматов)", done: true, price: 563, units: 'кв. м', amount:""},
            { work: "Монтаж распределительных коробок и подрозетников", done: true, price: 4456, units: 'шт', amount:""},
            { work: "Монтаж розеток и выключателей", done: true, price: 78, units: 'м', amount:""},
            { work: "Установка точечных светильников", done: true, price: 58, units: 'м', amount:""},
            { work: "Установка светильников, бра", done: true, price: 1258, units: 'кв. м', amount:""},
            { work: "Установка люминисцентных светильников", done: true, price: 5, units: 'шт', amount:""},
            { work: "Установка люстры", done: true, price: 54, units: 'м', amount:""},
            { work: "Установка и подключение входного звонка", done: true, price: 57, units: 'м', amount:""},
            { work: "Проектирование схемы силовой электропроводки с учетом нагрузок", done: true, price: 15, units: 'кв. м', amount:""}
        ]},
        {name: 'Клада плитки', price: [
            { work: "Укладка электрического кабеля", done: true, price: 15, units: 'шт', amount:""},
            { work: "Укладка гофры", done: true, price: 12, units: 'м', amount:""},
            { work: "Укладка металлорукава", done: true, price: 583, units: 'м', amount:""},
            { work: "Укладка кабель-канала", done: true, price: 55, units: 'кв. м', amount:""},
            { work: "Монтаж электрического щита", done: true, price: 418, units: 'шт', amount:""},
            { work: "Оборудование заземления, громоотвода", done: true, price: 156, units: 'м', amount:""},
        ]},
    ];
</script>
</body>
</html>